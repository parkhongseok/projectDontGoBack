# MSA 도입을 위한 서버 간 API 규격화

Date: 2025-08-03  
Status: Accepted

<br/>

## 맥락

DontGoBack 프로젝트는 단일 Core 서버를 중심으로 유저, 피드, 자산 등의 핵심 도메인을 운영해왔습니다.  
하지만 다음과 같은 이유로 마이크로서비스 아키텍처(MSA) 도입이 필요하다고 판단되었습니다.

- **서버 간 인증 체계 분리**: 기존 서버의 책임이 과도하게 집중됨
- **부가 기능의 독립성 확보**: 닉네임 갱신, 알림, 봇 등은 별도 책임 단위로 관리할 필요
- **확장성과 테스트 유연성 확보**: 기능별 서버 분리로 변경 영향도 최소화
- **라즈베리파이 환경 대응**: 리소스 제약 환경에서 모듈 단위 분산 운영이 유리

이에 따라 Core 서버 외부의 책임을 가진 기능들을 별도 서버로 분리하고,  
**서버 간 통신 규칙**, **API URL 패턴**, **레포지토리 컨벤션**을 명확히 정의하였습니다.

<br/>
<br/>
<br/>

## 결정

### 1. 레포지토리 구조

| 서버 이름         | 역할                               | 레포지토리 이름               |
| ----------------- | ---------------------------------- | ----------------------------- |
| **MSA 인증 서버** | 서버 간 토큰 발급, 공개키 제공     | `dg-msa-auth-server`          |
| **확장 서버**     | 닉네임 갱신, 알림, 봇 등 부가 기능 | `dg-extension-server`         |
| **코어 서버**     | 유저, 피드, 자산 등 핵심 도메인    | 기존 `projectDontGoBack` 유지 |

- **MSA 인증 서버**는 RS256 기반 JWT 발급과 공개키 제공만을 책임지며, 모든 마이크로서비스의 공통 인증 인프라로 사용됩니다.
- **확장 서버**는 비핵심 도메인을 대상으로 한 배치/스케줄 기반 기능을 담고 있으며, 초기에는 통합 구성 후 점진적 분리를 전제로 합니다.

<br/>
<br/>

### 2. API 엔드포인트 네이밍 컨벤션

모든 서버 간 통신 API는 `/msa/{server}/api/...` 패턴을 따릅니다.  
이를 통해 다음을 실현합니다:

- API의 **서비스 소속**을 URL만으로 명확하게 구분
- 보안 설정(SecurityFilterChain) 적용 경로를 일관되게 관리
- Swagger/OpenAPI 문서화 및 서버 간 통신 모니터링 시 혼동 방지

| 서비스             | API Prefix      | 주요 엔드포인트 예시                                              |
| ------------------ | --------------- | ----------------------------------------------------------------- |
| **인증 서버**      | `/msa/auth/api` | `/msa/auth/api/token`, `/msa/auth/api/public-key`                 |
| **확장 서버**      | `/msa/ext/api`  | `/msa/ext/api/nickname/update`, `/msa/ext/api/bot/feeds`          |
| **코어 서버 내부** | `/msa/core/api` | `/msa/core/api/feeds/update`, `/msa/core/api/users/state/refresh` |

> 외부 사용자용 API는 기존처럼 `/api/v1/...` 패턴을 유지합니다.

<br/>
<br/>
<br/>

## 결과

- **서버 간 책임과 경계를 URL과 코드 구조로 명확히 구분**할 수 있게 되었습니다.
- 인증 서버 분리로 인해 **서버 간 JWT 인증 체계를 중앙 집중화**할 수 있게 되었으며,
  RS256 방식의 인증 구조가 마이크로서비스 전체에 일관되게 적용됩니다.
- 확장 서버의 도입으로 Core 서버는 핵심 도메인 로직에 집중할 수 있으며,
  부가 기능은 모듈 단위로 유지/보수 및 독립 배포가 가능해졌습니다.

또한 추후 알림, 봇, 이름 갱신 외의 마이크로서비스가 추가되더라도,  
`/msa/{service}/api` 규칙을 통해 네이밍 일관성을 유지할 수 있으며,  
보안 정책, 라우팅, 모니터링, 로깅 등 전반적인 시스템 관리 효율이 크게 향상될 것으로 기대됩니다.
