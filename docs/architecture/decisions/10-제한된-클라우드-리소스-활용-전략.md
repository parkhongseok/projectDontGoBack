# 제한된 클라우드 리소스 활용 전략

Date: 2025-03-27

## 상태

적용 중

## 맥락

### 문제 1. 메모리 부족 및 OOM 발생

- 프리 티어 범위 내에서 서비스를 운영하기 위해 EC2 t2.micro 인스턴스를 선택했습니다.  
  해당 인스턴스는 `vCPU 1개`,` RAM 1GB`로 매우 제한적인 자원을 제공합니다.

- Spring Boot 기반의 백엔드, Next.js 기반의 프론트엔드, MariaDB를 동시에 구동할 경우,  
  메모리와 디스크 자원 모두 부족해 **OOM(Out of Memory) 발생 및 컨테이너 종료** 현상이 반복되었습니다.

- 또한 CPU 크레딧 고갈로 인해 EC2가 정지한 것처럼 반응하지 않거나, SSH 접속조차 어려운 상황이 발생하였습니다.

<br/>

### 문제 2. 디스크 압박 및 스왑 공간 부족

- 기본 루트 디스크(8GB)에 OS, 도커 이미지, 로그 등이 누적되면서 여유 공간이 거의 남지 않았습니다.

- 스왑 파일을 생성할 수 없어 메모리 부족 시 시스템이 정상적으로 대응할 수 없는 상태가 되었습니다.

<br/>
<br/>

## 결정

자원 제약을 해결하기 위해 다음과 같은 두 가지 조치를 취하였습니다.

### 1. EBS 볼륨 추가 및 스왑 파일 분리

| 항목          | 설명                             |
| ------------- | -------------------------------- |
| 사용한 서비스 | Amazon EBS (Elastic Block Store) |
| 볼륨 크기     | 5GB (프리 티어 범위 내)          |
| 파일 시스템   | ext4                             |
| 마운트 위치   | /mnt/data                        |
| 스왑 위치     | /mnt/data/swapfile               |

- AWS 콘솔을 통해 같은 가용 영역(ap-northeast-2c)에 EBS 볼륨을 추가 생성하고 EC2에 `/dev/xvdf`로 연결하였습니다.
- 해당 디스크에 파일 시스템(ext4)을 생성하고 `/mnt/data`에 마운트한 후, 스왑 파일을 `/mnt/data/swapfile`에 생성하였습니다.
- 이로써 루트 디스크를 소모하지 않고도 안정적인 스왑 영역 확보가 가능해졌습니다.

<br/>

---

<br/>

### 2. systemd 기반 시스템 복구 자동화 도입

| 항목        | 설명                                  |
| ----------- | ------------------------------------- |
| 대상        | docker-compose 기반 앱 전체           |
| 실행 방식   | foreground (non-detached)             |
| 재시작 정책 | `Restart=on-failure` + `RestartSec=5` |
| 로그 확인   | `journalctl -u dontgoback.service`    |

- **docker-compose를 systemd 서비스로 등록**하여, 서버 재부팅 혹은 앱 비정상 종료 시 자동 복구가 가능하도록 구성하였습니다.

- 이를 통해 CPU 크레딧 고갈 등으로 인한 시스템 중단 이후에도 자동으로 서비스를 복원할 수 있게 되었습니다.

<br/>
<br/>

## 결과

!["CPU 사용량 그래프"](../src/10-제한된-클라우드-리소스-활용-전략1.png)

| 항목                        | 개선 전            | 개선 후                |
| --------------------------- | ------------------ | ---------------------- |
| CPU 사용률 (최대 시점 기준) | 100%               | 20% 수준으로 안정화    |
| 디스크 공간 활용            | 루트 디스크에 집중 | EBS 분산 구성으로 분리 |
| 메모리 부족 대응            | 대응 불가          | 스왑 파일 기반 완화    |
| 시스템 복구                 | 수동 재기동 필요   | 자동 재기동 가능       |

- **CPU 최대 사용률 100% -> 20%로 안정화**

- 스왑 파일을 분리 구성함으로써 메모리 부족 시 시스템이 안정적으로 연명할 수 있는 기반을 마련하였습니다.

- systemd를 통한 복구 전략을 구성하여, 일시적인 시스템 중단이 발생하더라도 자동 재시작이 가능한 구조를 확보하였습니다.

- 이 전략은 프리 티어와 같이 자원이 극도로 제한된 환경에서도 서비스 생존성을 확보할 수 있는 실용적인 대응책으로 작용합니다.

<br/>
<br/>

---

#### ※ 전체 과정과 상세한 내용은 [블로그 포스트](https://keinmall.tistory.com/20)를 통해 확인하실 수 있습니다.
