# 외부 통신 기반의 도메인 동기화 시 트랜잭션 분리 전략

Date: 2025-08-07  
Status: Accepted

<br/>

## 맥락

Core 서버는 MSA 구조에서 확장 서버에 자산 갱신 요청을 전송하고,  
그 결과를 바탕으로 내부 도메인인 `User`, `AssetHistory`를 동기화합니다.

하지만 이 흐름에서 다음과 같은 문제가 발생할 수 있었습니다:

| 구분               | 문제 내용                                                                        |
| ------------------ | -------------------------------------------------------------------------------- |
| **외부 통신 예외** | API 요청 중 타임아웃, 5xx 응답 등으로 인해 트랜잭션 자체가 실패 가능             |
| **DB 일관성 문제** | 외부 응답은 실패했는데, 트랜잭션 일부만 반영되는 케이스 발생 가능                |
| **재시도 불가**    | 트랜잭션 내에서 외부 요청을 수행하면 예외 발생 시 전체 롤백되어 상태 추적 어려움 |

<br/>

위와 같은 복합 문제는 서비스 일관성과 추후 디버깅/재처리에 큰 부담을 줄 수 있으므로,  
**외부 통신 흐름과 내부 DB 갱신 흐름을 명확히 분리하는 전략**이 필요했습니다.

<br/>
<br/>

## 결정

Core 서버에서는 다음과 같은 방식으로 **트랜잭션 분리 전략**을 채택하였습니다:

<br/>

### 1. 요청-저장 흐름의 분리

```plaintext
       [요청 단계]                   [저장 단계 : 트랜잭션 내]
 ┌─────────────────────┐       ┌────────────────────────────┐
 │   외부 서버에 요청 전송  │  ->   │    응답 기반으로 도메인 갱신     │
 └─────────────────────┘       └────────────────────────────┘
```

- `InterServerApiExecutor를` 통해 외부 서버에 요청 전송

- 응답이 정상일 경우에만 `@Transactional` 메서드(`persistAssetChange`)에서 다음 작업 수행:

  - `AssetHistory` 저장
  - `User.currentAssetHistory` 갱신

<br/>

### 2. 외부 통신 흐름과 DB 흐름 간 의존 최소화

- 외부 API 응답 실패 시 → 도메인 저장 로직은 아예 수행되지 않음
- 내부 트랜잭션에서 예외 발생 시 → 외부 서버에는 영향 없음

<br/>

### 3. 사용 사례

```java
// 외부 API 요청 (트랜잭션 밖)
UpdateAssetResponse res = apiExecutor.executeWithToken(jwt ->
    assetClient.updateAsset(userId, jwt, new UpdateAssetRequest(currentAsset))
);

// 내부 DB 갱신 (트랜잭션 내)
@Transactional
public void persistAssetChange(User user, long updatedAsset) {
    AssetHistory history = AssetHistory.of(user, updatedAsset);
    assetHistoryRepository.save(history);

    user.setCurrentAssetHistory(history);
    userRepository.save(user);
}
```

<br/>
<br/>

## 결과

이와 같은 구조 설계를 통해 다음과 같은 효과를 얻을 수 있었습니다:

#### ① 데이터 무결성

- 외부 통신 실패 시 내부 DB에 아무런 변경도 발생하지 않음

#### ② 장애 전파 차단

- 외부 서버의 문제로 Core 서버 트랜잭션이 영향을 받지 않음

#### ③ 유지보수 용이성

- 요청/응답 → 저장 흐름이 명확히 분리되어 디버깅 및 로깅이 쉬움

#### ④ 재시도 유연성

- 요청 실패 시 DB 롤백 없이 부분 재시도가 가능함

<br/>

이러한 전략은 MSA 환경에서 **외부 통신의 불확실성**과 **내부 도메인의 일관성** 사이 균형을 고려한 의사 결정으로,  
이후 **확장 서버가 증가**하거나, **통신 실패율이 높아지는 상황**에서도 안정적으로 대응할 수 있도록 기반을 마련하였습니다.

> 관련 코드는 [`/src/main/.../InterServerAssetUpdateService.java`](/dg-core-server/src/main/java/com/dontgoback/dontgo/interserver/extension/asset/InterServerAssetUpdateService.java) 에서 확인하실 수 있습니다.
