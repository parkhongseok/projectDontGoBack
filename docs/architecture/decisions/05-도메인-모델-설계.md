# 도메인 모델 설계

Date: 2025-02-13

## 상태

적용 중

## 맥락

도메인 간 연관관계를 바탕으로, 데이터 모델링을 진행하였다. \
본 서비스에서는 유저의 자산(Asset)이 곧 유저의 닉네임(Author)이 되는 구조다. \
즉, `매일 갱신되는 유저의 자산 상태에 따라 작성자의 표시 이름이 변경`된다.

하지만 이 과정에서 이전 게시물 및 답글의 작성자가 현재 유저 정보와 동일하게 적용되는 문제가 발생한다. \
이 문제 해결하는 과정에서, 게시물(Feeds)과 답글(Comments) 테이블에 `작성 당시의 Author와 Type을 저장할 것인지`에 대한 고민이 필요했다.

<pre>
문제 자체는 join시 where 조건을 추가하는 것만으로 쉽게 해결되었다.
</pre>

아래는 정규화 후 반정규화 적용 여부에 대한 비교다.

### 반정규화 전 (정규화 상태)

- feeds 테이블에 user_id만 포함
- feeds와 asset_history의 join을 통해서, 게시물의 작성자와 타입을 조회
- 예시

  - 게시물 정보 (feeds 테이블) 예시
    | id | user_id | content |create_at |
    | :----------: |:----------: |:----------: |:----------: |
    | 214 | 1 | Hello World! | 3월 11일 17:02 |

  - 유저의 자산 변동 내역 (asset_history 테이블) 예시
    | id | user_id | asset |create_at |
    | :----------: |:----------: |:----------: |:----------: |
    | 6 | 1 | 1500 | 3월 10일 |
    | 7 | 1 | `-3000`| 3월 11일 |
    | 8 | 1 | -200 | 3월 12일 |

  <pre>
  정규화 상태의 단점
    1. 조회 성능 감소 
       author와 feedType을 저장할 필요가 없지만, 조회할 때마다 JOIN이 필요하다.
  </pre>

### 반정규화 후

- author와 feedType을 feeds, comments 테이블에 추가

  - 게시물 정보 (feeds 테이블) 예시
    | id | user_id | asset | feed_type | content | create_at |
    | :-: | :-----: | :-------: | :-------: | :----------: | :------------: |
    | 214 | 1 | `3000원 ` | `RED` | Hello World! | 3월 11일 17:02 |

  <pre>
  반정규화 시 단점
    1. 데이터 중복 발생
       user_id만으로도 조회할 수 있는 정보를 테이블에 중복 저장
    2. 정합성 문제 발생 가능
       author, ~Type이 여러 테이블에 존재하므로 데이터 일관성을 유지에 주의 필요
       (userType, feedType, commentType)
  </pre>

## 결정

<pre>
1. 반정규화 상태 유지
2. 개선 사항 검토
</pre>

!["Domain Architecture"](./05-도메인-모델-설계.jpg)

<pre>
  일대다 관계를 명확히 표기를 위해서 '*' 대신 'N'을 사용
</pre>

## 결과

현재 asset_history에서만 유저의 자산을 정수형으로 기록하고 있다.
하지만 feeds에 저장될 때, 이를 각각 varchar(author)와 enum(feedType)으로 변환하여 저장하고 있다.

### 문제점

- DB의 공간 낭비
  - 중복 저장으로 인해 데이터가 많아질수록 비용 증가
- 데이터 무결성 문제
  - user_Type, feedType, commentType 등 여러 컬럼이 동일한 정보를 다르게 저장하면서 불일치 가능성 증가

### 개선 방안

#### 방법 1 : `이름과 타입을 서버에서 변환 (DTO 활용)`

- 변경 사항

  - DB에는 부호를 포함한 asset 값만 저장
  - 데이터를 조회할 때 DTO에서 author와 feedType을 변환하여 제공
  - 게시물 정보 (feeds 테이블) 예시
    | id | user_id | asset | content | create_at |
    | :-: | :-----: | :-------: | :----------: | :------------: |
    | 214 | 1 | `-3000` | Hello World! | 3월 11일 17:02 |

- 기대 효과
  - DB 공간 절약
  - 성능 유지
  - 서버 부담 증가

#### 방법 2 : `이름과 타입을 클라이언트에서 변환`

- 변경 사항

  - DB 및 DTO에서 부호를 포함한 asset 값 그대로 제공
  - 클라이언트에서 author와 feedType을 변환

- 기대 효과
  - DB 공간 절약
  - 성능 유지
  - 클라이언트 부담 증가
