# OAuth2 및 JWT기반 인증/인가 아키텍처

Date: 2025-02-25

## 상태

적용 중

## 맥락

서비스의 회원 인증 방식을 고민한 결과, OAuth2 + JWT 기반 인증 방식을 적용하기로 결정했다. \
다음과 같은 흐름으로 결정했다.

#### 문제 1. 인증 방식 선택 : 폼 로그인 vs `소셜 로그인`

- 소셜 로그인 방식 선택 (간편한 로그인 제공)
- 여러 소셜 로그인 제공 시, 사용자가 로그인한 계정을 혼동할 가능성 고려
- 구글(Google) 단일 플랫폼 로그인 지원 (국내·외 범용 사용 가능)

#### 문제 2. 인증 상태 유지 : Session-Cookie vs `JWT`

- 서비스 확장을 고려하여 세션-쿠키 방식 대신, 토큰 기반 인증을 채택
- OAuth2.0을 통해 인증을 사용자에게 위임하고, JWT를 발급하여 사용자 식별 및 인가 수행

#### 문제 3. 보안 대책 : Spring Security 활용 방안

- 모든 쿠키에 HttpOnly, Secure 옵션 활성화
  - Secure 사용 : HTTPS 환경에서만 전송
  - HttpOnly 사용 : JavaScript 접근 차단
    - 사전작업
    <pre>
    1. 배포 서버(EC2)의 고정 IP 발급
    2. 도메인 할당 (A 레코드 설정)
    3. SSL 인증서 발급
    4. nginx 리버스 프록시 설정 (80 → 443)</pre>
- SecurityContextHolder 내 인증 객체 활용
  - 하나의 요청마다 유저 인증 객체가 컨텍스트 홀더에 저장되므로, 전역적으로 접근 가능
  - 스레드별로 공유되지 않으므로 안전함

## 결정

<pre>
Spring Security 기반 JWT/OAuth2 회원 인증/인가 방식 결정
</pre>

!["OAuth2 Architecture"](./08-OAuth2-JWT-인증-인가-흐름.png)

## 결과

- 현재 OAuth2 및 JWT 기반 인증을 적용 중
- Access Token을 유저에게 전달하는 과정에서 보안 취약점 발견

  - 쿼리 파라미터를 통해 액세스 토큰을 전달하는 방식이 보안상 매우 위험
  - 임시 해결책
    - 사용자가 토큰을 로컬 스토리지에 저장한 후, URL을 교체하는 방식 적용
    - 하지만, 이는 일시적인 보안 우회(눈속임)이며, 장기적인 해결책이 필요
  - 임시 방문자용 Access Token 전달을 위해 이 방식 임시적으로 유지


- 현재 OAuth2를 사용하고 있지만, OIDC 도입 검토 중
  - 사용하지 않을 이유가 없음
  - 단순 로그인만 필요하므로 OIDC(OpenID Connect) 도입이 유리
  - 하지만 OAuth2 인증 흐름을 완전히 이해하기 위해 현재는 보류
