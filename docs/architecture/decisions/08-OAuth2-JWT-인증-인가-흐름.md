# OAuth2 및 JWT기반 인증/인가 아키텍처

Date: 2025-02-25

## 상태

적용 중

## 맥락

다음과 같은 흐름을 통해 OAuth2 + JWT 기반 인증 방식을 적용하기로 결정했다.
회원 인증 관련 요구사항은 아래와 같았다.

<pre>
  1. 접속이 간편해야 한다.
  2. 접속이 유지되어야 한다.
  3. 유저 정보가 안전해야 한다.
</pre>

#### 문제 1. 간편한 접속 방법 고려 : 폼 로그인 vs `소셜 로그인`

- 매번 id와 pw를 입력하는 건 불편한 일이다. 소셜로그인이 간편하다고 판단했다.
- 하지만 여러 소셜 로그인 제공 시, 사용자가 로그인한 계정을 혼동할 가능성 고려했다.
- 따라서 `구글 단일 플랫폼의 소셜 로그인 방식`을 지원하기로 결정했다.

#### 문제 2. 인증 상태 유지 방식 고려 : Session-Cookie vs `JWT`

- 서비스 확장을 고려하여 세션-쿠키 방식 대신, 토큰 기반 인증을 채택했다.
- OAuth2.0을 통해 인증을 사용자에게 위임하고, JWT를 발급하여 사용자 식별 및 인가를 수행한다.
- 만료 기간이 짧은 Access Token과 재발급을 위한 Refresh Token을 같이 운영한다.

#### 문제 3. 보안 대책 : Spring Security 활용 방안

- OAuth2+JWT를 Spirng security와 함께 사용하는 방식을 선택했다.
- BASE64로 인코딩된 JWT는 복호화가 너무 간편하므로 HTTPS위에서만 이를 주고 받으며
- 유저 측에서 JavaScript로 쿠키를 직접 조작할 수 없도록 Spring Security 설정을 활성화한다.
  - Secure 옵션 활성화 : HTTPS 환경에서만 전송
  - HttpOnly 옵션 활성화 : JavaScript 접근 차단
    - 사전작업
      <pre>
      1. 배포 서버(EC2)의 고정 IP 발급
      2. 도메인 할당 (A 레코드 설정)
      3. SSL 인증서 발급
      4. nginx 리버스 프록시 설정 (80 → 443)</pre>
- SecurityContextHolder 내 인증 객체 활용하여 서버의 성능적 이점을 기대할 수 있다.
  - 하나의 요청마다 유저 인증 객체가 컨텍스트 홀더에 저장되므로, 전역적으로 접근 가능
  - 스레드별로 공유되지 않으므로 안전함

## 결정

<pre>
Spring Security 기반 JWT/OAuth2 회원 인증/인가 방식 결정
</pre>

!["OAuth2 Architecture"](../src/08-OAuth2-JWT-인증-인가-흐름.png)

## 결과

- 현재 OAuth2 및 JWT 기반 인증을 적용 중

  - 이 방식을 통해 DB에서 인증 회원 정보를 다시 조회하는 과정을 요청마다 1회 줄일 수 있었다.
  <pre>
    UserDeteils를 상속받은 User객체를 구현하여, 이를 인증 객체로 사용하도록 수정 
      기존 : Principal 객체 -> getEmail -> findByEmail -> User객체 획득)
      현재 : @AuthenticationPrincipal User me 즉시 획득)
  </pre>

- Access Token을 유저에게 전달하는 과정에서 보안 취약점 발견

  - 쿼리 파라미터를 통해 액세스 토큰을 전달하는 방식이 보안상 매우 위험
    (이를테면 로그아웃 후 이전페이지로 이동하면, AccessToken 다시 획득 가능)
  - 임시 해결책
    - 사용자가 토큰을 로컬 스토리지에 저장한 후, URL을 교체하는 방식 적용
    - 하지만, 이는 일시적인 보안 우회(눈속임)이며, 장기적인 해결책이 필요 => Access Token도 쿠키에 저장하도록 변경 예정
  - 임시 방문자용 Access Token 전달을 위해 이 방식 임시적으로 유지

- 현재 OAuth2를 사용하고 있지만, OIDC 도입 검토 중
  - 사용하지 않을 이유가 없음
  - 단순 로그인만 필요하므로 OIDC(OpenID Connect) 도입이 유리
  - 하지만 OAuth2 인증 흐름을 완전히 이해하기 위해 현재는 보류
