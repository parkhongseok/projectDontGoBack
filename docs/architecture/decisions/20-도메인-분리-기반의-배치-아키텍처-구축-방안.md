# 도메인 분리 기반의 배치 아키텍처 구축 방안

Date: 2025-08-10   
Status: 진행 중

<br/>

## 맥락

DontGoBack 프로젝트 코어 서버에 **일일 자산 정보 갱신 배치 기능**을 구현합니다.

본 기능의 주요 목표는 다음과 같습니다.
- **주기적 갱신**: 매일 지정된 시각에 모든 활성 사용자(Active User)의 자산을 외부 API를 통해 최신 정보로 갱신합니다.
- **이력 관리**: 갱신된 자산 정보를 `AssetHistory`에 기록하고, 사용자의 `currentAssetHistory` 참조를 업데이트하여 데이터 정합성을 유지합니다.
- **테스트 용이성 확보**: 테스트 환경에서 날짜를 제어할 수 있도록 `Clock` 객체를 주입하고 Mock을 적극적으로 활용하는 구조를 적용합니다.

<br/>
<br/>

## 결정 
### 1. 디렉터리 구조

배치 관련 로직을 **역할과 책임에 따라 명확히 분리**하여 유지보수성과 확장성을 확보하는 데 중점을 두었습니다.  
 도메인(`asset`)과 공통(`common`) 로직을 분리하여 향후 새로운 도메인의 배치가 추가되더라도 기존 코드에 영향을 주지 않도록 설계했습니다.

```
/batch
├── asset
│   ├── job
│   │   └── AssetRefreshJob.java         # Spring Batch의 Job 정의
│   ├── scheduler
│   │   └── DailyAssetRefreshScheduler.java # @Scheduled를 통한 주기적 실행
│   └── usecase
│       ├── AssetRefreshUseCase.java     # 실제 자산 갱신 비즈니스 로직
│       └── LocalBatchKickController.java  # 테스트/수동 실행을 위한 API
└── common
├── config
│   ├── BatchProperties.java         # 배치 관련 설정값 관리
│   └── SchedulingConfig.java        # 스케줄링 활성화 설정
└── dto
└── BatchResult.java             # 배치 결과 DTO
```

- **`batch.asset`**: '자산(Asset)' 도메인에 특화된 배치 로직을 그룹화합니다.
- **`batch.common`**: 여러 배치에서 재사용될 수 있는 설정(`config`), DTO 등을 위치시켜 중복을 최소화합니다.
- 이 구조를 통해 **새로운 도메인(예: `user`)의 배치를 추가할 때 `batch.user` 패키지를 생성하는 것만으로 손쉽게 확장이 가능**합니다.

<br/>
<br/>

### 2. 주요 결정 사항

#### ①. `AssetHistory` 엔티티 개선
- 데이터 무결성 강화를 위해 `snapshotDay` 필드를 추가하고, **`(user_id, snapshot_day)`에 복합 유니크 제약 및 인덱스를 적용**했습니다.
- 향후 리워드/패널티 등 외부 요인에 의한 자산 변동을 기록하기 위해 `netFlow` 컬럼을 추가할 계획입니다.

<br/>

#### ②. 서비스 로직 개선
- `AssetHistoryService.create()` 메서드에 `Clock`을 주입하여, **테스트 코드에서 원하는 날짜로 시간을 고정**할 수 있도록 개선했습니다.
- 배치 로직(`InterServerAssetUpdateService`)이 지정된 날짜로 히스토리를 생성하고 업데이트하도록 구현했습니다.

<br/>

#### ③. 테스트 구조 개선
- `@SpringBootTest` + `@Transactional` + `@Rollback` 조합으로 각 테스트 케이스가 독립적으로 실행되고 종료 시 롤백되도록 하여 **테스트 격리 수준을 높였습니다.**  
- `@MockBean`으로 외부 연동 서비스를 모킹하여 외부 환경 변화에 영향받지 않는 안정적인 테스트를 구축했습니다.  
- **부분 실패 시나리오**를 테스트에 포함하여, 특정 사용자의 자산 갱신이 실패하더라도 다른 사용자들의 갱신 작업은 정상적으로 완료되는 것을 검증했습니다.  

<br/>
<br/>

## 결과

| 항목 | 내용 |
| :--- | :--- |
| **적용 범위** | 코어 서버의 자산 배치 갱신 기능 전체 |
| **데이터 무결성** | 동일 사용자에 대해 같은 날짜의 자산 스냅샷이 중복 생성되는 것을 방지 |
| **테스트 커버리지** | 단일 성공 및 부분 실패 시나리오 모두 테스트 통과 |
| **향후 계획** | `netFlow` 정책 구체화, 보상 로직 추가, Snapshot/History 테이블 구조 분리 검토 |

앞으로 `netFlow` 컬럼을 도입하여 리워드/패널티를 자산에 반영하고, 이를 기반으로 한 색상 정책을 개선할 예정입니다.   
또한, 데이터가 누적됨에 따라 하루 변동 이력을 `AssetHistory`에 기록하고, 일일 스냅샷은 별도 테이블로 집계하여 분리하는 구조를 고려하고 있습니다.
