# 인덱스 생성을 통한 DB 성능 향상

Date: 2025-05-29

## 상태

적용 중

## 맥락

본 프로젝트는 피드 기반 SNS 서비스로, 메인 피드 목록 조회 기능이 사용자 경험에 직접적인 영향을 미치는 핵심 로직 중 하나입니다.
이에 따라, 대용량 데이터 환경에서의 조회 성능을 개선하는 작업이 필요했습니다.

<br/>

### 문제 1. 대용량 피드 조회 시 성능 저하

- 약 1,000,000건 이상의 피드 데이터를 대상으로, 다음 조건을 이용한 최신순 조회 쿼리를 반복적으로 수행하였습니다:
  ```sql
  SELECT * FROM feeds
  WHERE id < ? AND deleted_at IS NULL
  ORDER BY created_at DESC
  LIMIT 10
  ```
  - 실행 계획 분석 결과에서 **Using filesort**, **Using temporary**가 지속적으로 발생하며, 응답 시간이 수천 ms 이상으로 측정되었습니다.

<br/>

---

<br/>

### 문제 2. JOIN 최적화 시도 실패

- 서브쿼리를 제거하고 JOIN을 활용하는 방식으로 쿼리를 개선하려 하였으나,

- 데이터 양이 많아질수록 JOIN 비용이 증가하였고, 오히려 전체 수행 시간이 악화되는 현상이 발생하였습니다.

<br/>

---

<br/>

### 문제 3. 성능 측정 자동화의 필요성 인지

- 다양한 조건과 인덱스 조합을 실험하는 과정에서, 쿼리 실행 시간 측정 및 시각화에 상당한 수작업이 필요하였고,

- 성능 분석 과정을 자동화해야 할 필요성이 확인되었습니다.

<br/>
<br/>

## 결정

이러한 문제들을 해결하기 위해 아래와 같은 조치를 도입하였습니다.

### 1. 사용자 중심 정렬 최적화를 위한 복합 인덱스 생성

```sql
CREATE INDEX idx_feeds_deleted_created ON feeds(deleted_at, created_at DESC)

CREATE INDEX idx_comment_feed_deleted ON comments(feed_id, deleted_at)
```

| 항목               | 인덱스 적용 전                  | 인덱스 적용 후                                |
| ------------------ | ------------------------------- | --------------------------------------------- |
| `feeds` 접근 방식    | ref (user_id 외래키 기준 )      | range (deleted_at, created_at 기준 범위 조회) |
| 정렬 처리 방식     | Using temporary; Using filesort | 제거됨 (filesort 없음)                        |
| `users` 접근 방식    | index (풀 인덱스 스캔)          | eq_ref (정확한 단건 접근)                     |
| 댓글 서브쿼리 처리 | where 조건만 사용               | where + index 활용 가능                       |

- `comments` 테이블에도 `feed_id`와 `deleted_at`을 기준으로 복합 인덱스를 생성하여, 서브쿼리 조건 최적화 효과를 유도하였습니다.
- 특히 `feeds(deleted_at, created_at DESC)` 복합 인덱스를 통해 정렬 조건과 필터 조건이 동시에 커버되도록 구성하였습니다.

<br/>

---

<br/>

### 2. 성능 측정 자동화 도구 개발
- 반복되는 실험과 로그 측정의 불편함을 해소하기 위해,
- 쿼리 실행 시간 측정 및 결과 시각화를 자동화하는 QueryBenchmark 도구를 자체 개발하였습니다.

- 다양한 조건에서의 실행 시간 비교 및 그래프 분석을 자동화하였고, 개선 효과를 수치로 확인할 수 있도록 구성하였습니다.

> 자세한 코드는 [ Github 링크](https://github.com/parkhongseok/QueryBenchmark)에서 확인하실 수 있습니다.


<br/>
<br/>

## 결과

!["메인 피드 조회 평균 실행 시간 비교"](../src/13-인덱스-생성을-통한-DB-성능-향상.png)

① 복합 인덱스 적용 전후로 `수천 배 수준의 성능 차이`를 만들었습니다.  
특히 최신 피드 조회 시 `filesort` 제거로 인해 조회 시간이 **약 1,683**배 개선되었습니다.

② 댓글 수가 많은 중간 피드에 대해서도 `comments(feed_id, deleted_at)` 인덱스가 효과적으로 작용하여, 서브쿼리 처리 시간이 크게 단축되었습니다.

③ 과거 피드 조회의 경우, 인덱스 유무와 관계없이 이미 처리 속도가 매우 빠르게 나타났으며, 최적화 필요성이 낮은 것으로 판단되었습니다.

  - 전체적으로 메인 피드 조회 쿼리는 정**렬 제거와 조건 필터 최적화**만으로도 현격한 개선 효과가 있음을 확인하였습니다.

  - 향후에도 데이터 증가에 따른 성능 저하를 방지하기 위해, 정렬과 필터 조건을 동시에 만족하는 **복합 인덱스 전략**을 중심으로 성능을 지속적으로 모니터링할 예정입니다.


<br/>
<br/>

---

#### ※ 상세한 실험과 성능 측정 결과는 [블로그 포스트](https://keinmall.tistory.com/21)를 통해 확인하실 수 있습니다.
